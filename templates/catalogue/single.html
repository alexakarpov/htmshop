{% extends "../base.html" %}
{% block title %}
  {% if product %}
    {{ product.title }}
  {% else %}
    Product
  {% endif %}
{% endblock title %}
{% block content %}
  <div class="container">
    <div class="card mb-3 border-0">
      <div class="row g-0">
        <div class="col-md-12">
          <div class="card-body p-1">
            <p class="display-4 pt-4 text-center fw-bold lead mb-0 pe-4 pb-4">{{ product.title }}</p>
            <img class="img-fluid mx-auto d-block"
                 src="{{ product.image.url }}"
                 alt="{{ product.title }}" />
            <details class="description">
              <summary class="mt-2" data-open="hide" data-close="read more"></summary>
              {% autoescape off %}
                {{ product.description }}
              {% endautoescape %}
            </details>
          </div>
        </div>
      </div>
    </div>
    {% if skus %}
      <div class="input-group overflow-auto">
        <table class="table table-striped">
          <tbody>
            {% for i in skus %}
              <tr class="choice_item" data-sku="{{ i.sku }}">
                <td>
                  <strong>
                    {% if i.spec %}<i>{{ i.spec }}</i>{% endif %}
                  </strong>
                </td>
                <td>
                  <strong>${{ i.price }}</strong>
                </td>
                <td>
                  <input class="form-check-input sku-picker"
                         type="radio"
                         name="sku-radio"
                         value="{{ i.sku }}"
                         {% if skus.count == 1 %}checked{% endif %}>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <label for="quantity" class="p-1 fs-6">Quantity:</label>
        <input class="form-control quantity"
               id="quantity"
               type="number"
               min="0"
               value="1" />
      </div>
      <button type="button"
              id="add-button"
              class="btn btn-md btn-success mx-1 mt-2 mb-1 form-control"
              {% if skus.count > 1 %}disabled{% endif %}>Add to cart</button>
    {% else %}
      <div class="alert alert-warning" role="alert">
        <span class="warning">Sorry, there's no inventory available for this product</span>
      </div>
    {% endif %}
    <div class="row m-1 alert alert-success" role="alert" id="cartalertbox"></div>
  </div>
  <script>
  /* $(document).on('click', '.choice_item', function(e) {
    if (e.currentTarget.style.background=="#ffff99") {
      e.currentTarget.style.background="#ffffff"
    } else {
      e.currentTarget.style.background="#ffff99"
    }
  }) */
  $(document).on('click', '.sku-picker', function (e) {
    $('#add-button').prop('disabled', false)
  })

  $(document).on('click', '#add-button', function (e) {
    e.preventDefault()
    let next = '{{referred}}'
    const d = {
      productqty: $('#quantity').val(),
      sku: $(".sku-picker:checked").val(),
      csrfmiddlewaretoken: '{{csrf_token}}',
      action: 'post',
      next
    }

    $.ajax({
      type: 'POST',
      url: '{% url "basket:add" %}',
      data: d,
      success: function (json) {
        $('#basket-qty').html(json.qty)
        $('#cartalertbox').show()
        $('#cartalertbox').text('{{product.title}} added to the cart')
        setTimeout(function () {
          $('#cartalertbox').hide()
          window.location.replace(next)
        }, 2000)
      },
      error: function (xhr, errmsg, err) {
        console.error("add POST failed", errmsg)
      }
    })
  })
  </script>
{% endblock content %}
