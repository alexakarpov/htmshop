{% extends "../base.html" %}
{% load static %}
{% block title %}
Payment
{% endblock %}
{% block content %}

<head>
  <script
    type="text/javascript"
    src="https://sandbox.web.squarecdn.com/v1/square.js"
  ></script>
  <script>
    const appId = 'sandbox-sq0idb-H9U7rreVn5iRv9za5FSlRg';
    const locationId = 'LCDT9FPECTMHA';

    async function initializeCard(payments) {
      const card = await payments.card();
      await card.attach('#card-container');

      return card;
    }

    async function createPayment(token, verificationToken) {
      const body = JSON.stringify({
        locationId,
        sourceId: token,
        verificationToken,
        idempotencyKey: window.crypto.randomUUID(),
      });
      let csrftoken = "{{ csrf_token }}"
      console.log("CSRF token: ", csrftoken)
      const paymentResponse = await fetch('/checkout/payment/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          // 'X-CSRF-Token': csrftoken
        },
        body,
      });
    }

    async function tokenize(paymentMethod) {
      const tokenResult = await paymentMethod.tokenize();
      if (tokenResult.status === 'OK') {
        return tokenResult.token;
      } else {
        let errorMessage = `Tokenization failed with status: ${tokenResult.status}`;
        if (tokenResult.errors) {
          errorMessage += ` and errors: ${JSON.stringify(
            tokenResult.errors
          )}`;
        }

        throw new Error(errorMessage);
      }
    }

    // Required in SCA Mandated Regions: Learn more at https://developer.squareup.com/docs/sca-overview
    async function verifyBuyer(payments, token) {
      const verificationDetails = {
        amount: '1.00',
        billingContact: {
          addressLines: ['123 Main Street', 'Apartment 1'],
          familyName: 'Doe',
          givenName: 'John',
          email: 'jondoe@gmail.com',
          country: 'US',
          phone: '3214563987',
          region: 'MA',
          city: 'Boston',
        },
        currencyCode: 'USD',
        intent: 'CHARGE',
      };

      const verificationResults = await payments.verifyBuyer(
        token,
        verificationDetails
      );
      return verificationResults.token;
    }

    // status is either SUCCESS or FAILURE;
    function displayPaymentResults(status) {
      const statusContainer = document.getElementById(
        'payment-status-container'
      );
      if (status === 'SUCCESS') {
        statusContainer.classList.remove('is-failure');
        statusContainer.classList.add('is-success');
      } else {
        statusContainer.classList.remove('is-success');
        statusContainer.classList.add('is-failure');
      }

      statusContainer.style.visibility = 'visible';
    }

    document.addEventListener('DOMContentLoaded', async function () {
      if (!window.Square) {
        throw new Error('Square.js failed to load properly');
      }

      let payments;
      try {
        payments = window.Square.payments(appId, locationId);
      } catch {
        const statusContainer = document.getElementById(
          'payment-status-container'
        );
        statusContainer.className = 'missing-credentials';
        statusContainer.style.visibility = 'visible';
        return;
      }

      console.log("payments initialized", payments)

      let card;
      try {
        card = await initializeCard(payments);
      } catch (e) {
        console.error('Initializing Card failed', e);
        return;
      }

      console.log("card initialized", card)

      async function handlePaymentMethodSubmission(event, card) {
        event.preventDefault();

        try {
          // disable the submit button as we await tokenization and make a payment request.
          cardButton.disabled = true;
          const token = await tokenize(card);
          const verificationToken = await verifyBuyer(payments, token);
          console.log("token:", token)
          const paymentResults = await createPayment(
            token,
            verificationToken
          );
          displayPaymentResults('SUCCESS');

          console.debug('Payment Success', paymentResults);
        } catch (e) {
          cardButton.disabled = false;
          displayPaymentResults('FAILURE');
          console.error(e.message);
        }
      }

      const cardButton = document.getElementById('card-button');
      cardButton.addEventListener('click', async function (event) {
        await handlePaymentMethodSubmission(event, card);
      });
    });
  </script>
</head>

<div class="container">
  <div class="col-12">
    <h1 class="h2">Payment methods</h1>
  </div>
  <div class="col-12">
    <p>Please select your payment option</p>
  </div>
  <hr />
</div>

<div class="container">
  <div class="row">
    <div class="col-6">
      <p>Pay with Paypal</p>
    </div>

    <div class="col-6">
      <p>Pay with a credit card</p>
      <form id="payment-form">
        <div id="card-container"></div>
        <button id="card-button" type="button">Pay $1.00</button>
      </form>
      <div id="payment-status-container"></div>
    </div>
  </div>

  {% endblock %}
</div>
